<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Avançado de Juros Compostos</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuração explícita para o modo escuro do Tailwind -->
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    
    <!-- React e Babel (versões de produção para melhor performance) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .dark .chart-container {
            background-color: #1f2937;
        }
        .chart-container {
            background-color: #ffffff;
        }
        /* Estilos para a scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #333;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div id="root"></div>

    <!-- O CÓDIGO DO ANÚNCIO FOI REMOVIDO DAQUI E AGORA É GERENCIADO PELO REACT ABAIXO -->

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // Componente de Ícone com SVGs embutidos
        const Icon = React.memo(({ name, className }) => {
            const icons = {
                TrendingUp: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                ),
                Sun: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                ),
                Moon: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                ),
                Trash2: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                ),
                PlusCircle: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></svg>
                ),
                Plus: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                ),
                Play: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="6 3 20 12 6 21 6 3"/></svg>
                ),
                Landmark: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 7 4 7"/></svg>
                ),
                PiggyBank: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15.5 6.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"/><path d="M11 14h2"/><path d="M2 12c0-2.8 2.2-5 5-5h1.2a3 3 0 0 1 2.8 2.1L12 12h-1a2 2 0 0 0-2 2v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1.3a3 3 0 0 0-1.2-2.5L15 12h1a2 2 0 0 0 2-2V9a1 1 0 0 0-1-1h-1a2 2 0 0 1-2-2V5a1 1 0 0 0-1-1H7a5 5 0 0 0-5 5v2a1 1 0 0 0 1 1h1"/><path d="M3 20a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V10"/></svg>
                ),
                CalendarDays: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                ),
                CheckCircle2: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
                ),
                XCircle: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                ),
                Download: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                )
            };
            return icons[name] || null;
        });

        // Hook para gerenciar o modo escuro
        function useDarkMode() {
            const [isDarkMode, setIsDarkMode] = useState(() => {
                if (typeof window !== 'undefined') {
                    return localStorage.theme === 'dark' || 
                           (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
                }
                return false;
            });

            useEffect(() => {
                const root = window.document.documentElement;
                if (isDarkMode) {
                    root.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    root.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [isDarkMode]);

            return [isDarkMode, setIsDarkMode];
        }

        // Hook para salvar o estado no localStorage
        const usePersistentState = (key, defaultValue) => {
            const [state, setState] = useState(() => {
                try {
                    const persistentValue = window.localStorage.getItem(key);
                    return persistentValue !== null ? JSON.parse(persistentValue) : defaultValue;
                } catch (error) {
                    console.error(`Erro ao ler a chave do localStorage “${key}”:`, error);
                    return defaultValue;
                }
            });

            useEffect(() => {
                try {
                    window.localStorage.setItem(key, JSON.stringify(state));
                } catch (error) {
                    console.error(`Erro ao definir a chave do localStorage “${key}”:`, error);
                }
            }, [key, state]);

            return [state, setState];
        };


        // Função para lidar com a mudança de valores nos inputs numéricos
        const handleNumericChange = (value, setter) => {
            if (value === '') {
                setter('');
            } else {
                const parsed = parseFloat(value);
                if (!isNaN(parsed)) {
                    setter(parsed);
                }
            }
        };
        
        const handleIntChange = (value, setter) => {
            if (value === '') {
                setter('');
            } else {
                const parsed = parseInt(value, 10);
                if (!isNaN(parsed)) {
                    setter(parsed);
                }
            }
        };

        // Componente para o painel de inputs, otimizado com React.memo
        const InputPanel = React.memo(({ title, currency, initialAmount, setInitialAmount, dailyRate, setDailyRate, duration, setDuration, durationType, setDurationType, additionalInvestments, onAddInvestment, onUpdateInvestment, onRemoveInvestment, scenario }) => (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md space-y-6">
                <h3 className="font-bold text-xl text-gray-800 dark:text-white">{title}</h3>
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Valor Inicial ({currency})</label>
                    <input type="number" value={initialAmount} onChange={(e) => handleNumericChange(e.target.value, setInitialAmount)} className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:ring-blue-500 focus:border-blue-500"/>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rendimento Diário (%)</label>
                    <div className="flex items-center space-x-4">
                        <input type="range" min="0.01" max="10" step="0.01" value={dailyRate} onChange={(e) => handleNumericChange(e.target.value, setDailyRate)} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"/>
                        <input type="number" value={dailyRate} onChange={(e) => handleNumericChange(e.target.value, setDailyRate)} className="w-24 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700"/>
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Período</label>
                    <div className="flex space-x-2">
                        <input type="number" value={duration} onChange={(e) => handleIntChange(e.target.value, setDuration)} className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700"/>
                        <select value={durationType} onChange={(e) => setDurationType(e.target.value)} className="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700">
                            <option value="days">Dias</option>
                            <option value="months">Meses</option>
                            <option value="years">Anos</option>
                        </select>
                    </div>
                </div>
                <div>
                    <h4 className="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">Aportes Adicionais</h4>
                    {additionalInvestments.map((inv, index) => (
                        <div key={index} className="flex items-center space-x-2 mb-2">
                            <input type="number" placeholder="Valor" value={inv.amount} onChange={(e) => onUpdateInvestment(index, 'amount', e.target.value, scenario)} className="w-1/2 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700"/>
                            <input type="date" value={inv.date} onChange={(e) => onUpdateInvestment(index, 'date', e.target.value, scenario)} className="w-1/2 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700"/>
                            <button onClick={() => onRemoveInvestment(index, scenario)} className="p-2 text-red-500 hover:text-red-700"><Icon name="Trash2" className="w-5 h-5"/></button>
                        </div>
                    ))}
                    <button onClick={() => onAddInvestment(scenario)} className="w-full mt-2 flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <Icon name="PlusCircle" className="mr-2 w-5 h-5"/> Adicionar Aporte
                    </button>
                </div>
            </div>
        ));

        // Componente para o card de resultados, otimizado com React.memo
        const ResultCard = React.memo(({ title, value, subValue, icon, color }) => (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-start space-x-4">
                <div className={`p-3 rounded-full ${color}`}>
                    <Icon name={icon} className="w-6 h-6 text-white" />
                </div>
                <div>
                    <p className="text-sm text-gray-500 dark:text-gray-400">{title}</p>
                    <p className="text-2xl font-bold text-gray-900 dark:text-white">{value}</p>
                    <p className="text-sm text-gray-500 dark:text-gray-400">{subValue}</p>
                </div>
            </div>
        ));
        
        // ==================================================================
        // INÍCIO DA MODIFICAÇÃO: Componente para o anúncio Adsterra
        // Este componente gerencia o script do anúncio de forma segura.
        // ==================================================================
        const AdsterraBanner = () => {
            const adLoaded = useRef(false);

            useEffect(() => {
                // Esta lógica garante que o script seja adicionado à página apenas uma vez.
                if (adLoaded.current) {
                    return;
                }

                const script = document.createElement('script');
                script.async = true;
                script.setAttribute('data-cfasync', 'false');
                script.src = "//pl27571134.revenuecpmgate.com/c929660418be7a779b205ca311d76a17/invoke.js";
                
                // Adicionamos o script ao final do body.
                document.body.appendChild(script);
                adLoaded.current = true;

            }, []); // O array vazio [] faz com que este código rode apenas na montagem do componente.

            // O componente renderiza o <div> que o script da Adsterra vai usar para injetar o anúncio.
            return (
                <div className="flex justify-center my-8">
                    <div id="container-c929660418be7a779b205ca311d76a17"></div>
                </div>
            );
        };
        // ==================================================================
        // FIM DA MODIFICAÇÃO
        // ==================================================================


        // Componente principal da aplicação
        const App = () => {
            const [isDarkMode, setIsDarkMode] = useDarkMode();
            
            // Estados persistentes
            const [scenarioMode, setScenarioMode] = usePersistentState('scenarioMode', 'single');
            const [initialAmountA, setInitialAmountA] = usePersistentState('initialAmountA', 23);
            const [dailyRateA, setDailyRateA] = usePersistentState('dailyRateA', 4);
            const [durationA, setDurationA] = usePersistentState('durationA', 1);
            const [durationTypeA, setDurationTypeA] = usePersistentState('durationTypeA', 'years');
            const [additionalInvestmentsA, setAdditionalInvestmentsA] = usePersistentState('additionalInvestmentsA', []);

            const [initialAmountB, setInitialAmountB] = usePersistentState('initialAmountB', 100);
            const [dailyRateB, setDailyRateB] = usePersistentState('dailyRateB', 2);
            const [durationB, setDurationB] = usePersistentState('durationB', 1);
            const [durationTypeB, setDurationTypeB] = usePersistentState('durationTypeB', 'years');
            const [additionalInvestmentsB, setAdditionalInvestmentsB] = usePersistentState('additionalInvestmentsB', []);

            const [exchangeRate, setExchangeRate] = usePersistentState('exchangeRate', 5.45);
            const [currency, setCurrency] = usePersistentState('currency', 'USD');
            const [targets, setTargets] = usePersistentState('targets', [100, 1000, 10000]);
            const [activeTab, setActiveTab] = usePersistentState('activeTab', 'chart');
            
            // Estado não persistente
            const [simulationResult, setSimulationResult] = useState(null);
            
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            const getTotalDays = (duration, durationType) => {
                const dur = parseInt(duration, 10) || 0;
                switch (durationType) {
                    case 'days': return dur;
                    case 'months': return dur * 30;
                    case 'years': return dur * 365;
                    default: return 0;
                }
            };

            const runSimulation = useCallback(() => {
                const performCalculation = (initialAmount, dailyRate, duration, durationType, additionalInvestments) => {
                    const totalDays = getTotalDays(duration, durationType);
                    const rate = (parseFloat(dailyRate) || 0) / 100;
                    let balance = parseFloat(initialAmount) || 0;
                    const dailyData = [];
                    const reachedTargets = {};
                    const unreachedTargets = [...targets];

                    const additionalInvestmentsMap = new Map();
                    additionalInvestments.forEach(inv => {
                        if (!inv.date) return; // Ignora aportes sem data
                        const date = new Date(inv.date);
                        const normalizedDate = new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()).toISOString().split('T')[0];
                        const amount = parseFloat(inv.amount) || 0;
                        additionalInvestmentsMap.set(normalizedDate, (additionalInvestmentsMap.get(normalizedDate) || 0) + amount);
                    });

                    const startDate = new Date();

                    for (let i = 0; i <= totalDays; i++) {
                        const currentDate = new Date(startDate);
                        currentDate.setDate(startDate.getDate() + i);
                        const normalizedCurrentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()).toISOString().split('T')[0];
                        
                        let dailyInterest = 0;
                        let addedAmount = 0;

                        if (i > 0) {
                           dailyInterest = balance * rate;
                           balance += dailyInterest;
                        }

                        if (additionalInvestmentsMap.has(normalizedCurrentDate)) {
                            addedAmount = additionalInvestmentsMap.get(normalizedCurrentDate);
                            balance += addedAmount;
                        }

                        dailyData.push({
                            day: i,
                            date: currentDate.toISOString().split('T')[0],
                            balance: balance,
                            dailyInterest: dailyInterest,
                            addedAmount: addedAmount
                        });

                        for (let j = unreachedTargets.length - 1; j >= 0; j--) {
                            const targetValue = parseFloat(unreachedTargets[j]) || 0;
                            if (balance >= targetValue) {
                                reachedTargets[targetValue] = currentDate.toISOString().split('T')[0];
                                unreachedTargets.splice(j, 1);
                            }
                        }
                    }
                    const totalAdded = additionalInvestments.reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);
                    return {
                        finalBalance: balance,
                        dailyData,
                        reachedTargets,
                        totalInvested: (parseFloat(initialAmount) || 0) + totalAdded
                    };
                };

                const resultA = performCalculation(initialAmountA, dailyRateA, durationA, durationTypeA, additionalInvestmentsA);
                let resultB = null;
                if (scenarioMode === 'compare') {
                    resultB = performCalculation(initialAmountB, dailyRateB, durationB, durationTypeB, additionalInvestmentsB);
                }

                setSimulationResult({ scenarioA: resultA, scenarioB: resultB });
            }, [initialAmountA, dailyRateA, durationA, durationTypeA, additionalInvestmentsA, initialAmountB, dailyRateB, durationB, durationTypeB, additionalInvestmentsB, scenarioMode, targets]);

            useEffect(() => {
                runSimulation();
            }, [runSimulation]);
            
            useEffect(() => {
                if (simulationResult && chartRef.current && activeTab === 'chart') {
                    const ctx = chartRef.current.getContext('2d');
                    const isDark = document.documentElement.classList.contains('dark');
                    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                    const textColor = isDark ? '#e5e7eb' : '#374151';

                    const datasets = [{
                        label: scenarioMode === 'compare' ? 'Cenário A' : 'Saldo',
                        data: simulationResult.scenarioA.dailyData.map(d => ({ x: new Date(d.date), y: d.balance })),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                    }];

                    if (scenarioMode === 'compare' && simulationResult.scenarioB) {
                        datasets.push({
                            label: 'Cenário B',
                            data: simulationResult.scenarioB.dailyData.map(d => ({ x: new Date(d.date), y: d.balance })),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                        });
                    }

                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: { datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { type: 'time', time: { unit: 'month', tooltipFormat: 'dd/MM/yyyy' }, grid: { color: gridColor }, ticks: { color: textColor } },
                                y: { beginAtZero: false, grid: { color: gridColor }, ticks: { color: textColor, callback: value => currency === 'USD' ? '$' + value.toLocaleString('en-US') : 'R$' + value.toLocaleString('pt-BR') } }
                            },
                            plugins: {
                                legend: { labels: { color: textColor } },
                                tooltip: { callbacks: { label: context => `${context.dataset.label || ''}: ${new Intl.NumberFormat(currency === 'USD' ? 'en-US' : 'pt-BR', { style: 'currency', currency: currency }).format(context.parsed.y)}` } }
                            }
                        }
                    });
                }
            }, [simulationResult, isDarkMode, activeTab, scenarioMode, currency]);

            const addInvestment = useCallback((scenario) => {
                const today = new Date().toISOString().split('T')[0];
                const setter = scenario === 'A' ? setAdditionalInvestmentsA : setAdditionalInvestmentsB;
                setter(prev => [...prev, { amount: '', date: today }]);
            }, [setAdditionalInvestmentsA, setAdditionalInvestmentsB]);

            const updateInvestment = useCallback((index, field, value, scenario) => {
                const setter = scenario === 'A' ? setAdditionalInvestmentsA : setAdditionalInvestmentsB;
                setter(prev => {
                    const newInvestments = [...prev];
                    if (field === 'amount') {
                         newInvestments[index][field] = value === '' ? '' : value;
                    } else {
                        newInvestments[index][field] = value;
                    }
                    return newInvestments;
                });
            }, [setAdditionalInvestmentsA, setAdditionalInvestmentsB]);

            const removeInvestment = useCallback((index, scenario) => {
                const setter = scenario === 'A' ? setAdditionalInvestmentsA : setAdditionalInvestmentsB;
                setter(prev => prev.filter((_, i) => i !== index));
            }, [setAdditionalInvestmentsA, setAdditionalInvestmentsB]);

            const addTarget = useCallback(() => setTargets(prev => [...prev, '']), [setTargets]);
            const updateTarget = useCallback((index, value) => {
                setTargets(prev => {
                    const newTargets = [...prev];
                    newTargets[index] = value === '' ? '' : value;
                    return newTargets;
                });
            }, [setTargets]);
            const removeTarget = useCallback((index) => setTargets(prev => prev.filter((_, i) => i !== index)), [setTargets]);

            const formatCurrency = useCallback((value, curr = currency) => {
                return new Intl.NumberFormat(curr === 'USD' ? 'en-US' : 'pt-BR', {
                    style: 'currency', currency: curr, minimumFractionDigits: 2, maximumFractionDigits: 2,
                }).format(parseFloat(value) || 0);
            }, [currency]);

            const exportToCSV = useCallback(() => {
                if (!simulationResult) return;
                const headers = scenarioMode === 'compare' ? ['Data', 'Juros (A)', 'Adicionado (A)', 'Saldo (A)', 'Juros (B)', 'Adicionado (B)', 'Saldo (B)'] : ['Data', 'Juros Diários', 'Valor Adicionado', 'Saldo'];
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";
                const dataA = simulationResult.scenarioA.dailyData;
                const dataB = simulationResult.scenarioB ? simulationResult.scenarioB.dailyData : [];
                const numRows = Math.max(dataA.length, dataB.length);
                for(let i = 0; i < numRows; i++) {
                    const row = [];
                    const d_a = dataA[i];
                    const d_b = dataB[i];
                    if (scenarioMode === 'compare') {
                        row.push(d_a ? d_a.date : (d_b ? d_b.date : ''));
                        row.push(d_a ? d_a.dailyInterest.toFixed(2) : '0.00');
                        row.push(d_a ? d_a.addedAmount.toFixed(2) : '0.00');
                        row.push(d_a ? d_a.balance.toFixed(2) : '');
                        row.push(d_b ? d_b.dailyInterest.toFixed(2) : '0.00');
                        row.push(d_b ? d_b.addedAmount.toFixed(2) : '0.00');
                        row.push(d_b ? d_b.balance.toFixed(2) : '');
                    } else {
                        row.push(d_a.date);
                        row.push(d_a.dailyInterest.toFixed(2));
                        row.push(d_a.addedAmount.toFixed(2));
                        row.push(d_a.balance.toFixed(2));
                    }
                    csvContent += row.join(",") + "\n";
                }
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "simulacao_investimento.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }, [simulationResult, scenarioMode]);

            return (
                <div className="min-h-screen p-4 sm:p-6 lg:p-8">
                    <header className="flex justify-between items-center mb-8">
                        <div className="flex items-center space-x-3">
                            <Icon name="TrendingUp" className="w-8 h-8 text-blue-500" />
                            <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Simulador de Juros Compostos</h1>
                        </div>
                        <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                            <Icon name={isDarkMode ? "Sun" : "Moon"} className="w-6 h-6" />
                        </button>
                    </header>

                    <main className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Coluna de Controles */}
                        <div className="lg:col-span-1 space-y-8">
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                                <h3 className="font-bold text-xl text-gray-800 dark:text-white mb-4">Configurações Gerais</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Moeda Base</label>
                                        <select value={currency} onChange={(e) => setCurrency(e.target.value)} className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700">
                                            <option value="USD">Dólar (USD)</option>
                                            <option value="BRL">Real (BRL)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Taxa de Câmbio (USD para BRL)</label>
                                        <input type="number" value={exchangeRate} onChange={(e) => handleNumericChange(e.target.value, setExchangeRate)} className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700"/>
                                    </div>
                                    <div>
                                        <h4 className="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">Metas de Saldo ({currency})</h4>
                                        {targets.map((target, index) => (
                                            <div key={index} className="flex items-center space-x-2 mb-2">
                                                <input type="number" placeholder="Meta" value={target} onChange={(e) => updateTarget(index, e.target.value)} className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700"/>
                                                <button onClick={() => removeTarget(index)} className="p-2 text-red-500 hover:text-red-700"><Icon name="Trash2" className="w-5 h-5"/></button>
                                            </div>
                                        ))}
                                        <button onClick={addTarget} className="w-full mt-2 flex items-center justify-center py-2 px-4 border border-dashed border-gray-400 dark:border-gray-500 rounded-md text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <Icon name="Plus" className="mr-2 w-5 h-5"/> Adicionar Meta
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                                <h3 className="font-bold text-xl text-gray-800 dark:text-white mb-4">Modo de Simulação</h3>
                                <div className="flex rounded-md shadow-sm">
                                    <button onClick={() => setScenarioMode('single')} className={`w-full py-2 px-4 rounded-l-md ${scenarioMode === 'single' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700'}`}>Único</button>
                                    <button onClick={() => setScenarioMode('compare')} className={`w-full py-2 px-4 rounded-r-md ${scenarioMode === 'compare' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700'}`}>Comparar</button>
                                </div>
                            </div>

                            <div className={`grid grid-cols-1 ${scenarioMode === 'compare' ? 'md:grid-cols-2 lg:grid-cols-1' : ''} gap-6`}>
                                <InputPanel 
                                    title={scenarioMode === 'compare' ? 'Cenário A' : 'Parâmetros'}
                                    currency={currency}
                                    initialAmount={initialAmountA} setInitialAmount={setInitialAmountA}
                                    dailyRate={dailyRateA} setDailyRate={setDailyRateA}
                                    duration={durationA} setDuration={setDurationA}
                                    durationType={durationTypeA} setDurationType={setDurationTypeA}
                                    additionalInvestments={additionalInvestmentsA}
                                    onAddInvestment={addInvestment}
                                    onUpdateInvestment={updateInvestment}
                                    onRemoveInvestment={removeInvestment}
                                    scenario="A"
                                />
                                {scenarioMode === 'compare' && (
                                    <InputPanel 
                                        title="Cenário B"
                                        currency={currency}
                                        initialAmount={initialAmountB} setInitialAmount={setInitialAmountB}
                                        dailyRate={dailyRateB} setDailyRate={setDailyRateB}
                                        duration={durationB} setDuration={setDurationB}
                                        durationType={durationTypeB} setDurationType={setDurationTypeB}
                                        additionalInvestments={additionalInvestmentsB}
                                        onAddInvestment={addInvestment}
                                        onUpdateInvestment={updateInvestment}
                                        onRemoveInvestment={removeInvestment}
                                        scenario="B"
                                    />
                                )}
                            </div>

                            <button onClick={runSimulation} className="w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <Icon name="Play" className="mr-2 w-5 h-5"/> Simular Crescimento
                            </button>
                        </div>

                        {/* Coluna de Resultados */}
                        <div className="lg:col-span-2 space-y-8">
                            {simulationResult && (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <ResultCard 
                                            title="Saldo Final (A)" 
                                            value={formatCurrency(simulationResult.scenarioA.finalBalance)}
                                            subValue={formatCurrency(simulationResult.scenarioA.finalBalance * (parseFloat(exchangeRate) || 0), currency === 'USD' ? 'BRL' : 'USD')}
                                            icon="Landmark"
                                            color="bg-blue-500"
                                        />
                                        <ResultCard 
                                            title="Total Investido (A)" 
                                            value={formatCurrency(simulationResult.scenarioA.totalInvested)}
                                            subValue={`Lucro: ${formatCurrency(simulationResult.scenarioA.finalBalance - simulationResult.scenarioA.totalInvested)}`}
                                            icon="PiggyBank"
                                            color="bg-green-500"
                                        />
                                        <ResultCard 
                                            title="Dias Simulados (A)" 
                                            value={getTotalDays(durationA, durationTypeA)}
                                            subValue={`${durationA} ${durationTypeA.replace(/s$/, '')}(s)`}
                                            icon="CalendarDays"
                                            color="bg-yellow-500"
                                        />
                                        {scenarioMode === 'compare' && simulationResult.scenarioB && (
                                            <>
                                                <ResultCard 
                                                    title="Saldo Final (B)" 
                                                    value={formatCurrency(simulationResult.scenarioB.finalBalance)}
                                                    subValue={formatCurrency(simulationResult.scenarioB.finalBalance * (parseFloat(exchangeRate) || 0), currency === 'USD' ? 'BRL' : 'USD')}
                                                    icon="Landmark"
                                                    color="bg-indigo-500"
                                                />
                                                <ResultCard 
                                                    title="Total Investido (B)" 
                                                    value={formatCurrency(simulationResult.scenarioB.totalInvested)}
                                                    subValue={`Lucro: ${formatCurrency(simulationResult.scenarioB.finalBalance - simulationResult.scenarioB.totalInvested)}`}
                                                    icon="PiggyBank"
                                                    color="bg-emerald-500"
                                                />
                                                <ResultCard 
                                                    title="Dias Simulados (B)" 
                                                    value={getTotalDays(durationB, durationTypeB)}
                                                    subValue={`${durationB} ${durationTypeB.replace(/s$/, '')}(s)`}
                                                    icon="CalendarDays"
                                                    color="bg-orange-500"
                                                />
                                            </>
                                        )}
                                    </div>
                                    
                                    <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                                        <h3 className="font-bold text-xl mb-4 text-gray-800 dark:text-white">Metas Atingidas (Cenário A)</h3>
                                        <ul className="space-y-3">
                                            {targets.sort((a, b) => (parseFloat(a) || 0) - (parseFloat(b) || 0)).map((target, index) => (
                                                <li key={index} className="flex justify-between items-center p-3 rounded-md bg-gray-50 dark:bg-gray-700">
                                                    <div className="flex items-center">
                                                        <Icon name={simulationResult.scenarioA.reachedTargets[target] ? "CheckCircle2" : "XCircle"} className={`w-6 h-6 mr-3 ${simulationResult.scenarioA.reachedTargets[target] ? 'text-green-500' : 'text-red-500'}`} />
                                                        <span className="font-medium">Atingir {formatCurrency(target)}</span>
                                                    </div>
                                                    <span className="text-sm text-gray-600 dark:text-gray-300">
                                                        {simulationResult.scenarioA.reachedTargets[target] 
                                                            ? `Em: ${new Date(simulationResult.scenarioA.reachedTargets[target] + 'T00:00:00').toLocaleDateString('pt-BR')}`
                                                            : 'Não atingido no período'
                                                        }
                                                    </span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>

                                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-2 sm:p-4">
                                        <div className="flex justify-between items-center mb-4 px-2 sm:px-0">
                                            <div className="border-b border-gray-200 dark:border-gray-700">
                                                <nav className="-mb-px flex space-x-4" aria-label="Tabs">
                                                    <button onClick={() => setActiveTab('chart')} className={`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${activeTab === 'chart' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                                                        Gráfico
                                                    </button>
                                                    <button onClick={() => setActiveTab('table')} className={`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${activeTab === 'table' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                                                        Tabela Detalhada
                                                    </button>
                                                </nav>
                                            </div>
                                            {activeTab === 'table' && (
                                                <button onClick={exportToCSV} className="flex items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                                    <Icon name="Download" className="mr-2 w-5 h-5"/> Exportar CSV
                                                </button>
                                            )}
                                        </div>

                                        <div style={{ display: activeTab === 'chart' ? 'block' : 'none' }}>
                                            <div className="h-96 chart-container p-4 rounded-lg">
                                                <canvas ref={chartRef}></canvas>
                                            </div>
                                        </div>

                                        <div style={{ display: activeTab === 'table' ? 'block' : 'none' }}>
                                            <div className="overflow-auto max-h-96 rounded-lg border border-gray-200 dark:border-gray-700">
                                                <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                                    <thead className="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                                        <tr>
                                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Data</th>
                                                            {scenarioMode === 'compare' ? (
                                                                <>
                                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Juros (A)</th>
                                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Saldo (A)</th>
                                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Juros (B)</th>
                                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Saldo (B)</th>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Juros Diários</th>
                                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aporte</th>
                                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Saldo</th>
                                                                </>
                                                            )}
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                                        {simulationResult.scenarioA.dailyData.map((day, index) => {
                                                            const dayB = simulationResult.scenarioB ? simulationResult.scenarioB.dailyData[index] : null;
                                                            return (
                                                                <tr key={index}>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{new Date(day.date + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                                                    {scenarioMode === 'compare' ? (
                                                                        <>
                                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600 dark:text-green-400">{formatCurrency(day.dailyInterest)}</td>
                                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right font-medium">{formatCurrency(day.balance)}</td>
                                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600 dark:text-green-400">{dayB ? formatCurrency(dayB.dailyInterest) : '-'}</td>
                                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right font-medium">{dayB ? formatCurrency(dayB.balance) : '-'}</td>
                                                                        </>
                                                                    ) : (
                                                                        <>
                                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600 dark:text-green-400">{formatCurrency(day.dailyInterest)}</td>
                                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-blue-600 dark:text-blue-400">{day.addedAmount > 0 ? formatCurrency(day.addedAmount) : '-'}</td>
                                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right font-medium">{formatCurrency(day.balance)}</td>
                                                                        </>
                                                                    )}
                                                                </tr>
                                                            )
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    </main>
                    
                    {/* O componente do anúncio é renderizado aqui, de forma segura, após o conteúdo principal */}
                    <AdsterraBanner />

                </div>
            );
        };

        // Inicia a aplicação React 18
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>

</body>
</html>
